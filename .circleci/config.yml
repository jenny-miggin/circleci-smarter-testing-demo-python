version: 2.1

# Demo for CircleCI Smarter Testing with pytest: discovery, splitting, impact analysis, auto-rerun.
# See https://circleci.com/docs/guides/test/getting-started-with-smarter-testing/
#
# Use workflow "smarter-testing-demo" when the testsuite plugin is available (local or CI).
# Use workflow "test-pytest-only" when the plugin is not installed.

jobs:
  test:
    docker:
      - image: cimg/python:3.12
    resource_class: small
    parallelism: 4
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-deps-{{ checksum "requirements.txt" }}
            - v1-deps-

      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
            pip install -e .

      - run:
          name: Run tests (Smarter Testing)
          command: |
            . venv/bin/activate
            export TEST_DEMO_SLOWDOWN=120
            circleci run testsuite "ci tests"

      - store_test_results:
          path: test-reports

      - store_artifacts:
          path: test-reports
          destination: test-results

  # Fallback: run pytest directly (no testsuite plugin). Splits test files by node.
  test-pytest:
    docker:
      - image: cimg/python:3.12
    parallelism: 4
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-deps-{{ checksum "requirements.txt" }}
            - v1-deps-

      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
            pip install -e .

      - run:
          name: Run tests (pytest, split by node)
          command: |
            . venv/bin/activate
            mkdir -p test-reports
            FILES=$(find ./tests -type f -name 'test*.py' | sort)
            INDEX=${CIRCLE_NODE_INDEX:-0}
            NODES=${CIRCLE_NODE_TOTAL:-1}
            echo "$FILES" | awk -v n=$NODES -v i=$INDEX 'NR % n == i' > /tmp/my_tests.txt
            echo "Node $((INDEX+1))/$NODES: $(wc -l < /tmp/my_tests.txt) test files"
            if [ -s /tmp/my_tests.txt ]; then
              pytest --disable-pytest-warnings --no-header --quiet --tb=short \
                --junit-xml="test-reports/tests-${CIRCLE_NODE_INDEX:-0}.xml" \
                $(cat /tmp/my_tests.txt)
            else
              echo '<?xml version="1.0"?><testsuites></testsuites>' > "test-reports/tests-${CIRCLE_NODE_INDEX:-0}.xml"
            fi

      - store_test_results:
          path: test-reports

      - store_artifacts:
          path: test-reports
          destination: test-results

workflows:
  smarter-testing-demo:
    jobs:
      - test

  # test-pytest-only:
  #   jobs:
  #     - test-pytest
