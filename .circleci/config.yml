version: 2.1

# Demo for CircleCI Smarter Testing with pytest: discovery, splitting, impact analysis, auto-rerun.
# See https://circleci.com/docs/guides/test/getting-started-with-smarter-testing/
#
# Use workflow "smarter-testing-demo" when the testsuite plugin is available (local or CI).
# Use workflow "test-pytest-only" when the plugin is not installed.

jobs:
  test:
    docker:
      - image: cimg/python:3.12
    resource_class: small
    parallelism: 4
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-deps-{{ checksum "requirements.txt" }}
            - v1-deps-

      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
            pip install -e .

      - run:
          name: Run tests (Smarter Testing)
          command: |
            . venv/bin/activate
            circleci run testsuite "ci tests"

      - store_test_results:
          path: test-reports

      - store_artifacts:
          path: test-reports
          destination: test-results

      - run:
          name: Persist test results to workspace
          command: |
            mkdir -p workspace-results/node-${CIRCLE_NODE_INDEX}
            cp -r test-reports/. workspace-results/node-${CIRCLE_NODE_INDEX}/

      - persist_to_workspace:
          root: workspace-results
          paths:
            - .

  gather-test-results:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: /tmp/workspace

      - run:
          name: List gathered test results
          command: |
            echo "Test results from all nodes:"
            find /tmp/workspace -type f -name "*.xml" | sort

      - store_artifacts:
          path: /tmp/workspace
          destination: all-test-results

workflows:
  smarter-testing-demo:
    jobs:
      - test
      - gather-test-results:
          requires:
            - test
            - test: 
                - success
                - failed